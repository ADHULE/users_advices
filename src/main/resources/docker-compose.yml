version: '3.8' # Version de la syntaxe Docker Compose

services: # Définition des services à déployer

  #  Service de base de données MariaDB
  db:
    container_name: mariadb_container       #  Nom valide sans caractère interdit
    image: mariadb:12.0.2-noble             # Image officielle basée sur Ubuntu 24.04
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: example        # Mot de passe du super utilisateur root
      MARIADB_DATABASE: useradvicesmariadb  # Nom de la base de données à créer automatiquement
      MARIADB_USER: app_user                # Nom d’un utilisateur personnalisé
      MARIADB_PASSWORD: app_pass            # Mot de passe de l’utilisateur personnalisé
    ports:
      - "3308:3306"                         # Redirige le port 3306 du conteneur vers le port 3308 de l’hôte
    volumes:
      - db_data:/var/lib/mysql              #  Volume persistant pour stocker les données de la base
    networks:
      - backend                             # Connecté au réseau interne "backend"

  #  Interface web simple pour gérer la base de données
  adminer:
    container_name: adminer_container       #  Nom corrigé sans version dans le nom
    image: adminer:5.0.2-standalone         # Version stable d'Adminer
    restart: always
    ports:
      - "9080:8080"                         # Accessible via http://localhost:9080
    depends_on:
      - db                                  # ⏳ Attend que le service "db" soit prêt
    networks:
      - backend

  #  Interface web avancée pour gérer MariaDB
  phpmyadmin:
    container_name: phpmyadmin_container    #  Nom corrigé
    image: phpmyadmin/phpmyadmin
    restart: always
    environment:
      PMA_HOST: db                          #  Hôte de la base de données
      PMA_PORT: 3306                        #  Port de connexion à MariaDB
    ports:
      - "9090:80"                           # Accessible via http://localhost:9090
    depends_on:
      - db
    networks:
      - backend

  #  Service SMTP local pour tester l’envoi/réception d’e-mails
  smtp4dev:
    container_name: smtp4dev_container
    image: rnwood/smtp4dev:v3
    restart: always
    ports:
      - "5001:80"                           # Interface web → http://localhost:5001
      - "2526:25"                           # Port SMTP simulé
      - "1153:143"                          # Port IMAP simulé
      - "1120:110"                          # Port POP3 simulé
    volumes:
      - smtp4dev-data:/smtp4dev             #  Volume pour stocker les messages et sessions
    environment:
      - ServerOptions__Urls=http://*:80
      - ServerOptions__HostName=smtp4dev
      - ServerOptions__LockSettings=true
      - ServerOptions__Mailboxes__0=Test=hello@world.com
      - ServerOptions__Database=database.db
      - ServerOptions__NumberOfMessagesToKeep=100
      - ServerOptions__NumberOfSessionsToKeep=50
      - ServerOptions__DisableIPv6=true
      - ServerOptions__TlsMode=None
    networks:
      - backend

# Déclaration des volumes persistants
volumes:
  db_data:
  smtp4dev-data:     # Volume pour smtp4dev

#  Déclaration du réseau interne utilisé par tous les services
networks:
  backend:
